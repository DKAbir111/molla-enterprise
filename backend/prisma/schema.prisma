generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             String               @id @default(uuid())
  email          String               @unique
  name           String
  password       String
  role           String               @default("member")
  organizationId String? // current/primary org
  organization   Organization?        @relation("PrimaryOrg", fields: [organizationId], references: [id])
  ownedOrgs      Organization[]       @relation("OrgOwner")
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  lastLoginAt    DateTime?
  deletedAt      DateTime?
  resetTokens    PasswordResetToken[]
  loginActivity  LoginActivity[]
}

model Organization {
  id        String   @id @default(uuid())
  name      String
  email     String
  phone     String
  address   String
  logoUrl   String?
  ownerId   String
  owner     User     @relation("OrgOwner", fields: [ownerId], references: [id])
  users     User[]   @relation("PrimaryOrg")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products     Product[]
  customers    Customer[]
  sells        Sell[]
  buys         Buy[]
  transactions Transaction[]
  vendors      Vendor[]
  dryingGains  DryingGain[]

  // One-to-one settings
  settings OrganizationSettings?

  // Alert snoozes
  alertSnoozes OrganizationAlertSnooze[]
}

model Product {
  id               String       @id @default(uuid())
  name             String
  type             String
  grade            String?
  price            Decimal      @db.Decimal(12, 2)
  buyPrice         Decimal      @default(0) @db.Decimal(12, 2)
  otherCostPerUnit Decimal      @default(0) @db.Decimal(12, 2)
  targetPrice      Decimal      @default(0) @db.Decimal(12, 2)
  unit             String
  stock            Int          @default(0)
  description      String?
  imageUrl         String?
  active           Boolean      @default(true)
  awaitingPurchase Boolean      @default(true)
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id])
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  sellItems        SellItem[]
  buyItems         BuyItem[]
  dryingGains      DryingGain[]

  @@index([organizationId])
}

model Customer {
  id             String       @id @default(uuid())
  name           String
  phone          String
  email          String?
  address        String
  avatarUrl      String?
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  sells          Sell[]

  @@index([organizationId])
}

model Sell {
  id               String       @id @default(uuid())
  shortCode        String?
  customerId       String
  customer         Customer     @relation(fields: [customerId], references: [id])
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id])
  status           String       @default("pending")
  deliveryAddress  String?
  date             DateTime     @default(now())
  createdAt        DateTime     @default(now())
  deliveredAt      DateTime?
  total            Decimal      @default(0) @db.Decimal(12, 2)
  discount         Decimal      @default(0) @db.Decimal(12, 2)
  paidAmount       Decimal      @default(0) @db.Decimal(12, 2)
  transportPerTrip Decimal      @default(0) @db.Decimal(12, 2)
  transportTrips   Int          @default(0)
  transportTotal   Decimal      @default(0) @db.Decimal(12, 2)

  items SellItem[]

  @@index([organizationId])
  @@index([customerId])
}

model SellItem {
  id          String  @id @default(uuid())
  sellId      String
  sell        Sell    @relation(fields: [sellId], references: [id], onDelete: Cascade)
  productId   String
  product     Product @relation(fields: [productId], references: [id])
  productName String
  quantity    Int
  price       Decimal @db.Decimal(12, 2)
  total       Decimal @db.Decimal(12, 2)

  @@index([sellId])
  @@index([productId])
}

model Buy {
  id               String       @id @default(uuid())
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id])
  vendorName       String?
  vendorPhone      String?
  total            Decimal      @default(0) @db.Decimal(12, 2)
  discount         Decimal      @default(0) @db.Decimal(12, 2)
  paidAmount       Decimal      @default(0) @db.Decimal(12, 2)
  transportPerTrip Decimal      @default(0) @db.Decimal(12, 2)
  transportTrips   Int          @default(0)
  transportTotal   Decimal      @default(0) @db.Decimal(12, 2)
  createdAt        DateTime     @default(now())

  items BuyItem[]

  @@index([organizationId])
}

model Vendor {
  id             String       @id @default(uuid())
  name           String
  phone          String
  email          String?
  address        String?
  avatarUrl      String?
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
}

model BuyItem {
  id          String  @id @default(uuid())
  buyId       String
  buy         Buy     @relation(fields: [buyId], references: [id], onDelete: Cascade)
  productId   String
  product     Product @relation(fields: [productId], references: [id])
  productName String
  quantity    Int
  price       Decimal @db.Decimal(12, 2)
  total       Decimal @db.Decimal(12, 2)

  @@index([buyId])
  @@index([productId])
}

model Transaction {
  id             String       @id @default(uuid())
  description    String
  type           String
  amount         Decimal      @db.Decimal(12, 2)
  category       String
  date           DateTime     @default(now())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  createdAt      DateTime     @default(now())

  @@index([organizationId])
}

model DryingGain {
  id             String       @id @default(uuid())
  productId      String
  product        Product      @relation(fields: [productId], references: [id])
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  quantity       Int
  unitCost       Decimal      @default(0) @db.Decimal(12, 2)
  note           String?
  createdAt      DateTime     @default(now())

  @@index([productId])
  @@index([organizationId])
}

model OrganizationSettings {
  id             String       @id @default(uuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id])

  // Notification toggles
  notifyLowStock     Boolean @default(true)
  notifyOrderUpdates Boolean @default(true)
  notifyReceivables  Boolean @default(true)
  notifyPayables     Boolean @default(true)
  emailAlerts        Boolean @default(false)
  smsAlerts          Boolean @default(false)

  // Thresholds & aging
  lowStockThreshold      Int @default(5)
  pendingOrderAgingHours Int @default(24)
  receivableReminderDays Int @default(3)
  payableReminderDays    Int @default(3)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OrganizationAlertSnooze {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  type           String // 'lowStock' | 'pendingOrder' | 'receivable' | 'payable'
  refId          String
  until          DateTime?
  permanent      Boolean      @default(false)
  createdAt      DateTime     @default(now())

  @@index([organizationId, type, refId])
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
}

model LoginActivity {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  ipAddress   String?
  userAgent   String?
  location    String?
  deviceLabel String?
  createdAt   DateTime @default(now())
  lastSeenAt  DateTime @updatedAt

  @@index([userId, createdAt])
}
